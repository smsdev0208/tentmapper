<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .pending {
            background: #fff3cd;
            color: #856404;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Firebase Connection Test</h1>
    
    <div class="test-card">
        <h2>1. Firebase SDK Loading <span id="sdk-status" class="status pending">Testing...</span></h2>
        <p id="sdk-message">Checking if Firebase SDK loads correctly...</p>
    </div>
    
    <div class="test-card">
        <h2>2. Firebase Initialization <span id="init-status" class="status pending">Testing...</span></h2>
        <p id="init-message">Checking Firebase initialization...</p>
    </div>
    
    <div class="test-card">
        <h2>3. Firestore Connection <span id="firestore-status" class="status pending">Testing...</span></h2>
        <p id="firestore-message">Testing Firestore read access...</p>
        <button onclick="testFirestoreRead()">Test Read</button>
        <button onclick="testFirestoreWrite()">Test Write</button>
        <pre id="firestore-result"></pre>
    </div>
    
    <div class="test-card">
        <h2>4. Storage Connection <span id="storage-status" class="status pending">Testing...</span></h2>
        <p id="storage-message">Testing Storage access...</p>
    </div>
    
    <div class="test-card">
        <h2>5. reCAPTCHA <span id="recaptcha-status" class="status pending">Testing...</span></h2>
        <p id="recaptcha-message">Checking reCAPTCHA...</p>
        <button onclick="testRecaptcha()">Test reCAPTCHA</button>
        <pre id="recaptcha-result"></pre>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Test 1: SDK Loading
        document.getElementById('sdk-status').className = 'status success';
        document.getElementById('sdk-message').textContent = 'âœ“ Firebase SDK loaded successfully';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyApM1SommsAgnnQmBKcWPhb6-6C9AneR5Q",
            authDomain: "tent-mapper.firebaseapp.com",
            projectId: "tent-mapper",
            storageBucket: "tent-mapper.firebasestorage.app",
            messagingSenderId: "985438520114",
            appId: "1:985438520114:web:8bc61865b4392466f0cd2b",
            measurementId: "G-22059713VZ"
        };

        // Test 2: Initialization
        let app, db, storage;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            storage = getStorage(app);
            
            document.getElementById('init-status').className = 'status success';
            document.getElementById('init-message').textContent = 'âœ“ Firebase initialized successfully';
            
            // Test Storage
            document.getElementById('storage-status').className = 'status success';
            document.getElementById('storage-message').textContent = 'âœ“ Storage initialized';
        } catch (error) {
            document.getElementById('init-status').className = 'status error';
            document.getElementById('init-message').textContent = 'âœ— Error: ' + error.message;
        }

        // Test 3: Firestore Read
        window.testFirestoreRead = async function() {
            const resultDiv = document.getElementById('firestore-result');
            resultDiv.textContent = 'Testing...';
            
            try {
                const querySnapshot = await getDocs(collection(db, 'tents'));
                document.getElementById('firestore-status').className = 'status success';
                document.getElementById('firestore-message').textContent = 'âœ“ Firestore read access works';
                resultDiv.textContent = `Success! Found ${querySnapshot.size} tent(s) in database.`;
                
                if (querySnapshot.size > 0) {
                    resultDiv.textContent += '\n\nSample tent data:\n' + 
                        JSON.stringify(querySnapshot.docs[0].data(), null, 2);
                }
            } catch (error) {
                document.getElementById('firestore-status').className = 'status error';
                document.getElementById('firestore-message').textContent = 'âœ— Firestore read failed';
                resultDiv.textContent = 'Error: ' + error.code + '\n' + error.message;
                
                if (error.code === 'permission-denied') {
                    resultDiv.textContent += '\n\nâš ï¸ PERMISSION DENIED - This means Firestore rules are not deployed!\n\n' +
                        'TO FIX:\n' +
                        '1. Go to: https://console.firebase.google.com\n' +
                        '2. Select project: tent-mapper\n' +
                        '3. Go to: Firestore Database > Rules\n' +
                        '4. Copy content from firestore.rules file\n' +
                        '5. Paste and click "Publish"';
                }
            }
        };

        // Test Firestore Write
        window.testFirestoreWrite = async function() {
            const resultDiv = document.getElementById('firestore-result');
            resultDiv.textContent = 'Testing write...';
            
            try {
                const testData = {
                    latitude: 47.6062,
                    longitude: -122.3321,
                    createdAt: serverTimestamp(),
                    lastVerifiedAt: serverTimestamp(),
                    status: 'pending',
                    votesYes: 0,
                    votesNo: 0,
                    photoUrls: [],
                    votingEndsAt: new Date(Date.now() + 24 * 60 * 60 * 1000),
                    recaptchaToken: 'test-token'
                };
                
                const docRef = await addDoc(collection(db, 'tents'), testData);
                document.getElementById('firestore-status').className = 'status success';
                document.getElementById('firestore-message').textContent = 'âœ“ Firestore write access works!';
                resultDiv.textContent = 'Success! Test tent created with ID: ' + docRef.id + 
                    '\n\nYou should see this tent appear on the map if you refresh index.html';
            } catch (error) {
                document.getElementById('firestore-status').className = 'status error';
                document.getElementById('firestore-message').textContent = 'âœ— Firestore write failed';
                resultDiv.textContent = 'Error: ' + error.code + '\n' + error.message;
                
                if (error.code === 'permission-denied') {
                    resultDiv.textContent += '\n\nâš ï¸ PERMISSION DENIED - Firestore rules not deployed!\n\n' +
                        'TO FIX:\n' +
                        '1. Go to: https://console.firebase.google.com\n' +
                        '2. Select project: tent-mapper\n' +
                        '3. Go to: Firestore Database > Rules\n' +
                        '4. Copy content from firestore.rules file\n' +
                        '5. Paste and click "Publish"';
                }
            }
        };

        // Test reCAPTCHA
        window.testRecaptcha = function() {
            const resultDiv = document.getElementById('recaptcha-result');
            
            if (typeof grecaptcha === 'undefined') {
                document.getElementById('recaptcha-status').className = 'status error';
                document.getElementById('recaptcha-message').textContent = 'âœ— reCAPTCHA not loaded';
                resultDiv.textContent = 'Error: grecaptcha is not defined. Check if reCAPTCHA script loaded.';
                return;
            }
            
            grecaptcha.ready(() => {
                grecaptcha.execute('6LctphMsAAAAAF7GKY3kY3AZ1TAg8fdyHqvqUfKL', { action: 'test' })
                    .then(token => {
                        document.getElementById('recaptcha-status').className = 'status success';
                        document.getElementById('recaptcha-message').textContent = 'âœ“ reCAPTCHA works';
                        resultDiv.textContent = 'Success! Token received:\n' + token.substring(0, 50) + '...';
                    })
                    .catch(error => {
                        document.getElementById('recaptcha-status').className = 'status error';
                        document.getElementById('recaptcha-message').textContent = 'âœ— reCAPTCHA failed';
                        resultDiv.textContent = 'Error: ' + error.message;
                    });
            });
        };

        // Auto-run Firestore read test
        setTimeout(() => {
            testFirestoreRead();
        }, 1000);
    </script>
    
    <!-- reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LctphMsAAAAAF7GKY3kY3AZ1TAg8fdyHqvqUfKL"></script>
</body>
</html>

